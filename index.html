<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>아카이빙 월드</title>
    <style>
      :root {
        --bg: #f6f6f6;
        --ink: #111;
        --scotch-1: #e7e6e3;
        --scotch-2: #e9e6e1;
        --bar-h: 96px;
        --tapeW: 60px;
        --tapeH: 40px;
        --tapeOpacity: 0.5;
        --tint: #ffffff;
        --tintOpacity: 0.2;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--ink);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          sans-serif;
        overflow: hidden;
      }

      /* 초기화 버튼 */
      #reset {
        position: fixed;
        top: 14px;
        left: 14px;
        z-index: 20;
        height: 36px;
        padding: 0 12px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: #fff;
        color: #111;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      #reset:active {
        transform: translateY(1px);
      }

      #boardsBtn {
        position: fixed;
        top: 14px;
        right: 14px;
        z-index: 21;
        height: 36px;
        padding: 0 12px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: #fff;
        color: #111;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      #boardsBtn:active {
        transform: translateY(1px);
      }

      /* 보드 패널 */
      #boardsPanel {
        position: fixed;
        top: 60px;
        right: 14px;
        z-index: 22;
        width: 400px;
        max-height: calc(100vh - 80px);
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.12);
        border-radius: 12px;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.14);
        display: none;
        overflow: hidden;
      }
      #boardsHeader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        background: linear-gradient(180deg, #fff, #f7f7f7);
      }
      #boardsHeader .title {
        font-weight: 800;
      }
      #boardsHeader .actions {
        display: flex;
        gap: 6px;
      }
      .btn-sm {
        height: 30px;
        padding: 0 10px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: #fff;
        cursor: pointer;
        font-weight: 700;
      }
      .btn-sm.black {
        background: #242424;
        color: #fff;
        border-color: rgba(0, 0, 0, 0.25);
      }
      .btn-sm:hover {
        filter: brightness(0.97);
      }
      .list {
        padding: 8px;
        overflow: auto;
        max-height: calc(100% - 46px);
      }
      .board-item {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 6px 8px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: #fafafa;
        margin-bottom: 8px;
      }
      .board-item.active {
        outline: 2px solid #111;
        background: #fff;
      }
      .board-name {
        font-weight: 800;
      }
      .board-meta {
        font-size: 12px;
        color: #666;
      }
      .board-actions {
        display: flex;
        gap: 6px;
      }
      .chip-btn {
        height: 26px;
        padding: 0 8px;
        border-radius: 7px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: #fff;
        cursor: pointer;
        font-weight: 700;
        font-size: 12px;
      }

      /* 보드 캔버스 */
      #board {
        position: relative;
        height: calc(100% - var(--bar-h) - 16px);
        margin: 8px;
        border-radius: 12px;
        background: linear-gradient(180deg, #fff, #f4f4f2);
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.06);
        isolation: isolate;
        overflow: hidden;
      }

      /* ★ 텍스트 맨 위에 */
      #labelLayer {
        position: absolute;
        inset: 0;
        z-index: 999999;
        pointer-events: none;
      }
      #labelLayer .label-ol {
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        height: var(--tapeH);
        padding: 0 10px;
        font-weight: 900;
        font-size: 15px;
        color: #111;
        white-space: nowrap;
        text-align: center;
        mix-blend-mode: normal;
        opacity: 1;
        filter: none;
      }

      /* 입력 바 */
      #bar {
        position: fixed;
        left: -20px;
        right: 12px;
        bottom: 8px;
        height: var(--bar-h);
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        z-index: 10;
      }
      .roll {
        flex: 1;
        height: 100%;
        position: relative;
        border-radius: 12px;
        padding: 10px 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: transparent;
        isolation: isolate;
        overflow: visible;
      }
      .roll::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 12px;
        pointer-events: none;
        z-index: 0;
        background: linear-gradient(180deg, var(--scotch-1), var(--scotch-2));
        box-shadow: 0 1px 0 rgba(255, 255, 255, 0.6) inset,
          0 -1px 0 rgba(0, 0, 0, 0.05) inset, 0 8px 16px rgba(0, 0, 0, 0.06);
      }
      .roll > * {
        position: relative;
        z-index: 1;
      }

      .roll .tint-preview {
        position: absolute;
        inset: 0;
        border-radius: 12px;
        pointer-events: none;
        z-index: 1;
        mix-blend-mode: multiply;
        background: var(--tint);
        opacity: var(--tintOpacity);
      }

      .roll:after {
        content: '';
        position: absolute;
        right: -18px;
        top: 2px;
        bottom: 2px;
        width: 32px;
        z-index: -10;
        pointer-events: none;
        background: var(--tint);
        opacity: var(--tintOpacity);
        clip-path: polygon(
          0 0,
          60% 8%,
          35% 18%,
          80% 28%,
          30% 40%,
          90% 54%,
          40% 66%,
          96% 78%,
          50% 90%,
          100% 100%,
          0 100%
        );
        mix-blend-mode: multiply;
        border-radius: 3px;
        box-shadow: inset -6px 0 0 rgba(0, 0, 0, 0.06);
      }

      /* 색 지정 버튼 */
      #word {
        flex: 1;
        height: 52px;
        background: transparent;
        border: none;
        border-radius: 10px;
        padding: 0 14px;
        font-size: 18px;
        color: #111;
        outline: none;
        appearance: none;
        box-shadow: none;
      }
      .ctrl {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      #tapeColor {
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        padding: 0;
        cursor: pointer;
      }

      /* 버튼 */
      #add {
        height: 52px;
        min-width: 96px;
        padding: 0 18px;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.25);
        background: #242424;
        color: #fff;
        font-weight: 800;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      #add:hover {
        background: #111;
      }
      #add:active {
        transform: translateY(1px);
      }

      /* === 테이프 === */
      .tape {
        position: absolute;
        min-width: var(--tapeW);
        height: var(--tapeH);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        cursor: grab;
      }
      .tape .bg {
        position: absolute;
        inset: 0;
        border: none;
        background: linear-gradient(180deg, var(--scotch-1), var(--scotch-2));
        box-shadow: 0 1px 0 rgba(255, 255, 255, 0.6) inset,
          0 -1px 0 rgba(0, 0, 0, 0.05) inset, 0 6px 12px rgba(0, 0, 0, 0.06);
        opacity: var(--tapeOpacity, 0.5);
        background-clip: padding-box;
        pointer-events: none;
        z-index: 0;
        mix-blend-mode: multiply;
      }
      .tape .tint {
        position: absolute;
        inset: 0;
        background: var(--tint, #ffd24d);
        opacity: var(--tintOpacity, 0.4);
        mix-blend-mode: multiply;
        pointer-events: none;
        z-index: 0;
      }
      .tape .chip {
        position: absolute;
        background: linear-gradient(180deg, var(--scotch-1), var(--scotch-2));
        opacity: var(--tapeOpacity, 0.9);
        pointer-events: none;
        z-index: -1;
        border-radius: 2px;
      }
      .tape .chip::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 2px;
        background: var(--tint, #ffd24d);
        opacity: var(--tintOpacity, 0.4);
        mix-blend-mode: multiply;
      }

      .tape .label {
        display: none;
      }

      .tape.stuck {
        --tapeOpacity: 1;
        cursor: default;
      }

      .toast {
        position: fixed;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: #1f1f1f;
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 13px;
        opacity: 0.34;
        z-index: 30;
      }

      .tomato {
        position: absolute;
        top: -60px;
        left: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        pointer-events: none;
        z-index: 5;
        background: radial-gradient(
          circle at 35% 30%,
          #ff8f8f 0%,
          #ff4040 40%,
          #d21f1f 70%,
          #b51818 100%
        );
        box-shadow: inset -6px -8px 10px rgba(0, 0, 0, 0.18),
          inset 6px 8px 12px rgba(255, 255, 255, 0.25),
          0 8px 18px rgba(0, 0, 0, 0.12);
      }
      .tomato:before {
        content: '';
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%) rotate(8deg);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 12px solid #1f7a2e;
        filter: drop-shadow(0 1px 0 rgba(0, 0, 0, 0.2));
      }
      @keyframes tomato-fall {
        0% {
          transform: translateY(0) scale(1);
        }
        70% {
          transform: translateY(var(--fallDist, 420px)) scale(1);
        }
        80% {
          transform: translateY(calc(var(--fallDist, 420px) - 14px)) scale(1.02);
        }
        100% {
          transform: translateY(var(--fallDist, 420px)) scale(1);
          opacity: 1;
        }
      }
      @keyframes tomato-fade {
        to {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <button id="reset" type="button">초기화</button>
    <button id="boardsBtn" type="button">보드 관리</button>

    <aside id="boardsPanel" aria-label="보드 목록">
      <div id="boardsHeader">
        <div class="title">보드 관리</div>
        <div class="actions">
          <button id="newBoard" class="btn-sm black" type="button">
            새 보드
          </button>
          <button id="saveAsBoard" class="btn-sm" type="button">
            다른 이름으로 저장
          </button>
          <button id="closePanel" class="btn-sm" type="button">닫기</button>
        </div>
      </div>
      <div id="boardsList" class="list" role="list"></div>
    </aside>

    <main id="board" aria-label="보드">
      <!-- ★ 텍스트 오버레이 레이어 -->
      <div id="labelLayer" aria-hidden="true"></div>
    </main>

    <section id="bar" aria-label="입력">
      <div class="roll" role="group">
        <div class="tint-preview" aria-hidden="true"></div>
        <input
          id="word"
          type="text"
          placeholder="테이프에 단어를 입력하세요!"
          autocomplete="off"
          autocapitalize="none"
          spellcheck="false"
          enterkeyhint="done"
          aria-label="단어 입력"
        />
        <div class="ctrl" aria-label="색상 지정">
          <input
            id="tapeColor"
            type="color"
            value="#ffd24d"
            title="테이프 색"
          />
          <div id="sw" class="swatch" title="미리보기"></div>
        </div>
        <button id="add" type="button">테이프 뜯기</button>
      </div>
    </section>

    <script>
      (function () {
        var board = document.getElementById('board');
        var labelLayer = document.getElementById('labelLayer');
        var input = document.getElementById('word');
        var addBtn = document.getElementById('add');
        var resetBtn = document.getElementById('reset');
        var colorInput = document.getElementById('tapeColor');
        var swatch = document.getElementById('sw');
        var roll = document.querySelector('#bar .roll');

        var LS_MULTI = 'tapeBoard_ascii_multi_v2_color';
        var LS_LEGACY = 'tapeBoard_ascii_v1';

        function cssVar(px) {
          var v = getComputedStyle(document.documentElement)
            .getPropertyValue(px)
            .trim();
          return parseInt(v, 10) || 0;
        }
        var TAPE_W = cssVar('--tapeW'),
          TAPE_H = cssVar('--tapeH');

        function uuid() {
          return window.crypto && crypto.randomUUID
            ? crypto.randomUUID()
            : String(Date.now() + Math.random());
        }
        function nowISO() {
          return new Date().toISOString();
        }
        function fmt(ts) {
          try {
            return new Date(ts).toLocaleString();
          } catch (e) {
            return ts || '';
          }
        }

        var zStack = 100;

        var store = loadStore();
        ensureStore();
        renderActiveBoard();
        updatePreview();

        function toast(msg) {
          var t = document.createElement('div');
          t.className = 'toast';
          t.textContent = msg;
          document.body.appendChild(t);
          setTimeout(function () {
            t && t.parentNode && t.parentNode.removeChild(t);
          }, 1400);
        }

        function snapshot() {
          var arr = [],
            nodes = board.querySelectorAll('.tape');
          nodes.forEach(function (n) {
            arr.push({
              id: n.dataset.id,
              text: n.querySelector('.label')
                ? n.querySelector('.label').textContent
                : document.querySelector(
                    '#labelLayer [data-for="' + n.dataset.id + '"]'
                  )?.textContent || '',
              x: parseFloat(n.style.left) || 24,
              y: parseFloat(n.style.top) || 24,
              stuck: n.classList.contains('stuck'),
              opacity:
                parseFloat(
                  getComputedStyle(n).getPropertyValue('--tapeOpacity')
                ) || 0.88,
              color: n.dataset.color || '#ffd24d',
              tintOpacity: 0.4,
            });
          });
          return { items: arr };
        }
        function save() {
          var s = snapshot();
          var cur = getActiveBoard();
          if (!cur) return;
          cur.items = s.items;
          cur.updatedAt = nowISO();
          persist();
        }

        function clearCanvas() {
          board.querySelectorAll('.tape').forEach(function (n) {
            n.remove();
          });
          labelLayer.innerHTML = '';
        }
        function loadItemsToCanvas(items) {
          clearCanvas();
          (items || []).forEach(spawn);
        }

        function createOverlayLabel(tapeEl, text) {
          var id = tapeEl.dataset.id;
          var ol = document.createElement('div');
          ol.className = 'label-ol';
          ol.dataset.for = id;
          ol.textContent = text;
          labelLayer.appendChild(ol);
          syncOverlayLabelRect(tapeEl);
          return ol;
        }
        function syncOverlayLabelRect(tapeEl) {
          var id = tapeEl.dataset.id;
          var ol = labelLayer.querySelector('[data-for="' + id + '"]');
          if (!ol) return;
          var rB = board.getBoundingClientRect();
          var rN = tapeEl.getBoundingClientRect();
          var left = rN.left - rB.left;
          var top = rN.top - rB.top;
          ol.style.left = left + 'px';
          ol.style.top = top + 'px';
          ol.style.width = rN.width + 'px';
          ol.style.height = rN.height + 'px';
        }

        /* === 드래그 === */
        function makeDraggable(node) {
          var sx = 0,
            sy = 0,
            ox = 0,
            oy = 0,
            dragging = false,
            pid = null;
          function move(e) {
            if (!dragging) return;
            var dx = e.clientX - sx,
              dy = e.clientY - sy;
            var rB = board.getBoundingClientRect(),
              rN = node.getBoundingClientRect();
            var left = Math.max(6, Math.min(rB.width - rN.width - 6, ox + dx));
            var top = Math.max(6, Math.min(rB.height - rN.height - 6, oy + dy));
            node.style.left = left + 'px';
            node.style.top = top + 'px';
            syncOverlayLabelRect(node);
          }
          function up() {
            if (!dragging) return;
            dragging = false;
            try {
              if (pid != null) node.releasePointerCapture(pid);
            } catch (err) {}
            window.removeEventListener('pointermove', move);
            window.removeEventListener('pointerup', up);
            save();
          }
          node.addEventListener(
            'pointerdown',
            function (e) {
              if (node.classList.contains('stuck')) return;
              if (typeof e.button !== 'undefined' && e.button !== 0) return;
              node.style.zIndex = ++zStack; /* 테이프 덧붙히기 */
              var r = node.getBoundingClientRect(),
                b = board.getBoundingClientRect();
              sx = e.clientX;
              sy = e.clientY;
              ox = r.left - b.left;
              oy = r.top - b.top;
              pid = e.pointerId;
              dragging = true;
              try {
                if (pid != null) node.setPointerCapture(pid);
              } catch (err) {}
              window.addEventListener('pointermove', move, { passive: true });
              window.addEventListener('pointerup', up, { passive: true });
              e.preventDefault();
            },
            { passive: false }
          );
          node.addEventListener('dblclick', function () {
            node.classList.toggle('stuck');
            save();
          });
        }

        /* === 삼각형 조각 === */
        function triClip(direction) {
          return direction === 'left'
            ? 'polygon(0% 50%, 100% 0%, 100% 100%)'
            : 'polygon(100% 50%, 0% 0%, 0% 100%)';
        }
        function stratifiedPositions(totalHeight, count, minPad) {
          var positions = [],
            segmentH = count > 0 ? totalHeight / count : totalHeight;
          for (var i = 0; i < count; i++) {
            var segTop = i * segmentH,
              segBottom = (i + 1) * segmentH;
            var low = segTop + minPad,
              high = segBottom - minPad;
            if (high < low) {
              var mid = (segTop + segBottom) / 2;
              low = mid;
              high = mid;
            }
            positions.push(low + Math.random() * Math.max(0, high - low));
          }
          return positions;
        }
        function addRandomChips(tapeEl) {
          var h = TAPE_H,
            countLeft = 6 + Math.floor(Math.random() * 3),
            countRight = 6 + Math.floor(Math.random() * 3);
          var W_MIN = 6,
            W_MAX = 14,
            H_MIN = 6,
            H_MAX = 14;
          function addOne(side, baseTop) {
            var chip = document.createElement('div');
            chip.className = 'chip ' + side;
            var w = W_MIN + Math.floor(Math.random() * (W_MAX - W_MIN + 1));
            var hh = H_MIN + Math.floor(Math.random() * (H_MAX - H_MIN + 1));
            var jitter = Math.floor(Math.random() * 5) - 2;
            var top = Math.max(
              0,
              Math.min(h - hh, Math.round(baseTop + jitter))
            );
            chip.style.width = w + 'px';
            chip.style.height = hh + 'px';
            chip.style.top = top + 'px';
            chip.style.clipPath = triClip(side);
            if (side === 'left') {
              chip.style.left = -w + 0.195 + 'px';
            } else {
              chip.style.right = -w + 0.195 + 'px';
            }
            tapeEl.appendChild(chip);
          }
          var posLeft = stratifiedPositions(h, countLeft, 0),
            posRight = stratifiedPositions(h, countRight, 0);
          addOne('left', 0);
          addOne('left', h);
          posLeft.forEach(function (y) {
            addOne('left', y);
          });
          addOne('right', 0);
          addOne('right', h);
          posRight.forEach(function (y) {
            addOne('right', y);
          });
        }

        /* ★ 텍스트 길이가 늘어나면 테이프도 늘어나긔 */
        function measureTextWidth(text) {
          var m = document.createElement('span');
          m.style.position = 'absolute';
          m.style.visibility = 'hidden';
          m.style.whiteSpace = 'nowrap';
          m.style.fontWeight = '900';
          m.style.fontSize = '15px';
          m.style.fontFamily =
            'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
          m.style.padding = '0 10px';
          m.textContent = text || '';
          document.body.appendChild(m);
          var w = m.offsetWidth;
          document.body.removeChild(m);
          return w;
        }
        function setTapeWidthByText(tapeEl, text) {
          var minW = TAPE_W; // 최소 너비
          var contentW = measureTextWidth(text);
          var finalW = Math.max(minW, contentW);
          tapeEl.style.width = finalW + 'px';
        }

        /* 테이프 생성 */
        function spawn(opt) {
          opt = opt || {};
          var v = (opt.text || '').trim();
          if (!v) return null;
          var color = opt.color || colorInput.value || '#ffd24d';

          var n = document.createElement('div');
          n.className = 'tape';
          n.dataset.id = opt.id || uuid();
          n.dataset.color = color;
          n.dataset.tintopacity = '0.4';
          n.style.zIndex = ++zStack;

          setTapeWidthByText(n, v);

          // 위치
          var x =
            typeof opt.x === 'number'
              ? opt.x
              : Math.random() * (board.clientWidth - (n.offsetWidth + 40)) + 20;
          var y = typeof opt.y === 'number' ? opt.y : 20;
          n.style.left = x + 'px';
          n.style.top = y + 'px';

          // 색 변수
          n.style.setProperty('--tint', color);
          n.style.setProperty('--tintOpacity', '0.4');

          // 레이어들
          var bg = document.createElement('div');
          bg.className = 'bg';
          var tint = document.createElement('div');
          tint.className = 'tint';
          var labelData = document.createElement('span');
          labelData.className = 'label';
          labelData.textContent = v;

          n.appendChild(bg);
          n.appendChild(tint);
          addRandomChips(n);
          n.appendChild(labelData);
          board.appendChild(n);

          createOverlayLabel(n, v);

          if (opt.stuck) n.classList.add('stuck');
          makeDraggable(n);

          requestAnimationFrame(function () {
            syncOverlayLabelRect(n);
          });

          save();
          return n;
        }

        function dropTomato() {
          var t = document.createElement('div');
          t.className = 'tomato';
          var bRect = board.getBoundingClientRect();
          var left = Math.max(
            8,
            Math.floor(Math.random() * (bRect.width - 56))
          );
          t.style.left = left + 'px';
          var fallDist = Math.max(120, bRect.height - 140);
          t.style.setProperty('--fallDist', fallDist + 'px');
          board.appendChild(t);
          t.style.animation =
            'tomato-fall 1.0s cubic-bezier(.2,.8,.2,1) forwards';
          setTimeout(function () {
            t.style.animation = 'tomato-fade 0.9s ease forwards';
          }, 2000);
          setTimeout(function () {
            t && t.parentNode && t.parentNode.removeChild(t);
          }, 3000);
        }

        function submit() {
          var v = input.value.trim();
          if (!v) return;
          if (v.toLowerCase() === 'tomato') dropTomato();
          var br = document.querySelector('#bar .roll').getBoundingClientRect();
          var b = board.getBoundingClientRect();
          spawn({
            text: v,
            color: colorInput.value,
            x:
              Math.random() * (board.clientWidth - (cssVar('--tapeW') + 40)) +
              20 /* 재조정 */,
            y: Math.max(12, br.top - b.top - (TAPE_H + 32)),
          });
          input.value = '';
          input.focus();
        }

        addBtn.addEventListener('click', submit);
        var composing = false;
        input.addEventListener('compositionstart', function () {
          composing = true;
        });
        input.addEventListener('compositionend', function () {
          composing = false;
        });
        input.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            if (e.isComposing || composing) return;
            e.preventDefault();
            submit();
          }
        });

        resetBtn.addEventListener('click', function () {
          clearCanvas();
          save();
          toast('현재 보드 초기화 완료');
        });

        /* ===== 보드 관리(원본 유지) ===== */
        function loadStore() {
          try {
            var raw = localStorage.getItem(LS_MULTI);
            if (raw) return JSON.parse(raw);
            var legacy = localStorage.getItem(LS_LEGACY);
            if (legacy) {
              var legacyData = JSON.parse(legacy);
              var id = uuid();
              var initial = { boards: {}, activeId: id };
              initial.boards[id] = {
                id,
                name: '내 보드',
                items: legacyData.items || [],
                updatedAt: nowISO(),
              };
              localStorage.setItem(LS_MULTI, JSON.stringify(initial));
              return initial;
            }
          } catch (e) {}
          return { boards: {}, activeId: null };
        }
        function persist() {
          try {
            localStorage.setItem(LS_MULTI, JSON.stringify(store));
          } catch (e) {}
          renderBoardsPanel();
        }
        function ensureStore() {
          if (!store || !store.boards) store = { boards: {}, activeId: null };
          if (!store.activeId || !store.boards[store.activeId]) {
            var id = uuid();
            store.boards[id] = {
              id,
              name: '보드 1',
              items: [],
              updatedAt: nowISO(),
            };
            store.activeId = id;
            persist();
          }
        }
        function getActiveBoard() {
          return store.boards[store.activeId] || null;
        }
        function setActiveBoard(id) {
          if (!store.boards[id]) return;
          save();
          store.activeId = id;
          persist();
          renderActiveBoard();
          toast('보드 전환: ' + (store.boards[id].name || id));
        }
        function renderActiveBoard() {
          var cur = getActiveBoard();
          clearCanvas();
          if (cur) loadItemsToCanvas(cur.items || []);
        }

        var boardsBtn = document.getElementById('boardsBtn');
        var boardsPanel = document.getElementById('boardsPanel');
        var boardsList = document.getElementById('boardsList');
        var newBoardBtn = document.getElementById('newBoard');
        var saveAsBtn = document.getElementById('saveAsBoard');
        var closePanel = document.getElementById('closePanel');
        boardsBtn.addEventListener('click', function () {
          renderBoardsPanel();
          boardsPanel.style.display =
            boardsPanel.style.display === 'block' ? 'none' : 'block';
        });
        closePanel.addEventListener('click', function () {
          boardsPanel.style.display = 'none';
        });
        newBoardBtn.addEventListener('click', function () {
          var name = prompt('새 보드 이름을 입력하세요', '새 보드');
          if (name && name.trim()) {
            createBoard(name.trim());
          }
        });
        saveAsBtn.addEventListener('click', function () {
          var name = prompt(
            '새 이름으로 저장',
            (getActiveBoard()?.name || '보드') + ' 사본'
          );
          if (name && name.trim()) {
            duplicateActiveBoard(name.trim());
          }
        });

        function renderBoardsPanel() {
          if (!boardsList) return;
          boardsList.innerHTML = '';
          var ids = Object.keys(store.boards);
          ids.sort(function (a, b) {
            var A = store.boards[a].updatedAt || '',
              B = store.boards[b].updatedAt || '';
            return A > B ? -1 : A < B ? 1 : 0;
          });
          ids.forEach(function (id) {
            var b = store.boards[id];
            var item = document.createElement('div');
            item.className =
              'board-item' + (id === store.activeId ? ' active' : '');
            var nameEl = document.createElement('div');
            nameEl.className = 'board-name';
            nameEl.textContent = b.name || '(이름 없음)';
            var metaEl = document.createElement('div');
            metaEl.className = 'board-meta';
            metaEl.textContent = ' 최근 수정 | ' + fmt(b.updatedAt);
            var actions = document.createElement('div');
            actions.className = 'board-actions';
            var openBtn = document.createElement('button');
            openBtn.type = 'button';
            openBtn.className = 'chip-btn';
            openBtn.textContent = '열기';
            var renameBtn = document.createElement('button');
            renameBtn.type = 'button';
            renameBtn.className = 'chip-btn';
            renameBtn.textContent = '이름 변경';
            var dupBtn = document.createElement('button');
            dupBtn.type = 'button';
            dupBtn.className = 'chip-btn';
            dupBtn.textContent = '복제';
            var delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'chip-btn';
            delBtn.textContent = '삭제';
            openBtn.addEventListener('click', function () {
              setActiveBoard(id);
            });
            renameBtn.addEventListener('click', function () {
              var nn = prompt('보드 이름 변경', b.name || '');
              if (nn && nn.trim()) renameBoard(id, nn.trim());
            });
            dupBtn.addEventListener('click', function () {
              var nn = prompt('복제본 이름', (b.name || '보드') + ' 복제');
              if (nn && nn.trim()) {
                var curActive = store.activeId;
                store.activeId = id;
                duplicateActiveBoard(nn.trim());
                store.activeId = curActive;
              }
            });
            delBtn.addEventListener('click', function () {
              if (
                confirm(
                  '이 보드를 삭제할까요? 한번 삭제하면 되돌릴 수 없습니다.'
                )
              )
                deleteBoard(id);
            });
            actions.appendChild(openBtn);
            actions.appendChild(renameBtn);
            actions.appendChild(dupBtn);
            actions.appendChild(delBtn);
            item.appendChild(nameEl);
            item.appendChild(actions);
            item.appendChild(metaEl);
            boardsList.appendChild(item);
          });
        }

        function createBoard(name) {
          var id = uuid();
          store.boards[id] = {
            id,
            name: name || '보드 ' + Object.keys(store.boards).length,
            items: [],
            updatedAt: nowISO(),
          };
          store.activeId = id;
          persist();
          renderActiveBoard();
          toast('새 보드 생성');
        }
        function duplicateActiveBoard(newName) {
          var cur = getActiveBoard();
          if (!cur) return;
          var id = uuid();
          store.boards[id] = {
            id,
            name: newName || cur.name + ' 복제',
            items: JSON.parse(JSON.stringify(cur.items || [])),
            updatedAt: nowISO(),
          };
          store.activeId = id;
          persist();
          renderActiveBoard();
          toast('보드 복제 완료');
        }
        function renameBoard(id, newName) {
          if (!store.boards[id]) return;
          store.boards[id].name = newName || store.boards[id].name;
          store.boards[id].updatedAt = nowISO();
          persist();
          toast('이름 변경 완료');
        }
        function deleteBoard(id) {
          var keys = Object.keys(store.boards);
          if (!store.boards[id] || keys.length <= 1) {
            toast('보드가 최소 1개는 유지되어야 합니다.');
            return;
          }
          delete store.boards[id];
          if (store.activeId === id) {
            store.activeId = keys.filter(function (k) {
              return k !== id;
            })[0];
          }
          persist();
          renderActiveBoard();
          toast('보드 삭제');
        }

        function updatePreview() {
          var color = colorInput.value;
          roll.style.setProperty('--tint', color);
          roll.style.setProperty('--tintOpacity', '0.4');
          swatch.style.background = color;
          swatch.style.opacity = 1;
        }
        colorInput.addEventListener('input', updatePreview);

        window.addEventListener('resize', function () {
          board.querySelectorAll('.tape').forEach(syncOverlayLabelRect);
        });
      })();
    </script>
  </body>
</html>
